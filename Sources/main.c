
//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
//---------------------- Pride Power------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
//* Project Name       : S223
//* File Name          : main.C
//* Author             : Clark
//* Software Version   : b010.1612.001
//* Start Date         : 2017.1.1                                   
//* Description        : BMS主板程序
//* Processor:         : Freescale MC2S12XEP100
//* Compiler:          : CodeWarriorV5.0 or higher
//* Details:           : 5个BMU板，单体总个数189，电芯类型为磷酸铁锂电池，176Ah
//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------
 
#include "BMS20.h"

/* global variables definitions */
//BMS Software Version define
unsigned char BMS_SW_Version[8]={0x0b,0x00,0x10,0x16,0x12,0x00,0x00,0x01};//b010.1612.001
unsigned char BMUOK=0;
//unsigned char BatCellNumber=BATTERYCELLNUMBER;   //电池单体个数
unsigned char BatType=CELL_TYPE;//电池类型
unsigned char HeatFlag; //上电前温度标志位
//**********************************************************************
//**********************************************************************
//**********************************************************************
//**********************************************************************
//**********************************************************************
//**********************************************************************
void main(void) 
{
    /* put your own code here */
    unsigned long t=0;
    //////////////////////////////////////////////
    ///////////////////////////////////////////////////////
    IVBR = 0x7f;  //向量表重新定位因为之前的空间被BOOTLOADER程序占用了  
    ////////////////////////////////////////////////////
    CLKSEL = 0x80;//PLLCLK = 1 选则PLL作为时钟  bus clock = pll clock/2 ,,16M晶振，BUSCLOCK = 16M
    while(CLKSEL & 0x80 == 0);
    //////////////////////////////////////////////////////////////    
    COPCTL |=0x07; //看门狗初始化，分频时钟为2的24次方; 大约2秒钟
    //////////////////////////////////////////////////////////////
    gpioInit(); //IO port initialize   
    ADCInitial(); //ADC初始化
    ads1015_init();
    read_adc_config();
    
    InitialHc595(); //Relay初始化                             
    MSCANInit();  //CAN初始化        
    PIT0_Init();
    RTIInit();  //设置定时器间隔时间    
    InitialAtM95M02();//M95M02 Flash初始化
    DFlash_Init(); //Data Flash初始化 
    Task02_BMN_GlobalVariables_Init(); 
    Task11_Vpn_StartAD_Polling(); //计算总电压值；此处不能删除，用于激活ADS1110
    
    
    
    ///////////////////////////////////////////////////
    delay(65000);  //19ms
    delay(65000); //cant delete
    ///////////////////////////////////////////////////
    InitialBMS();   //BCU初始化，包括参数，SOC，时间的初始化
    
    ////////////////////////////////////////////////////////
 
    turnOnLED0(); 	     // for debug 
    ////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////
    Interrupt_Priority_Set();
    EnableInterrupts; //开中断，接收状态机编码 
    TurnOnCan2Rx(); //打开内部中断，接收BMU数据
    ///////////////////////////////////////////////////////
    BMU_initial();//////BMU自检
    GetDCTem();  //获取快充座正负温度
    
    bmsModeAwake();//系统模式判断
    
    if(g_BatHighestTemp>45+40)
        Tavg=g_BatHighestTemp;
    else
        Tavg=g_BatLowestTemp;
    if(Tavg<=40) //小于0度
    {
        HeatFlag=1;
    }
    else if (Tavg<=50) //0-10度
    {
        HeatFlag=2;
    }
    else           //大于10度
        HeatFlag=3;
    BMUOK = 1;
    //****************************************************************               
    SocOCVAdjust(30); //SOC OCV修正120min
    InitialSoc();   //SOC，初始容量，剩余容量初始化，必须要在BMU数据都收到后才读取，否则温度不对，额定容量计算会错       
    //*******************************************************************
    S223_StateMachine_initialize();
    TotalVoltageOverVoltage_initialize();
    TotalVoltageUnderVoltage_initialize();
    while(1) 
    {
        _FEED_COP();   //2s内不喂内狗，则系统复位
        TaskProcess(); 
    }  
    //****************************************************************** 
    //////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////
  /* please make sure that you never leave main */
}
//*********************************************************************
//*********************************************************************
//**********************the end ****************************************
//*********************************************************************
//*********************************************************************
//*********************************************************************